{% extends "layout.html" %}
{% block title %}{{ campname }} Group Editor{% endblock %}
{% block pagename %}
    {% if targetuser.userid is not none and thisuser.isadmin == 1 %}
    &#34;{{ targetuser.firstname }} {{ targetuser.lastname }}&#34; Editor
    {% elif thisuser.isadmin != 1 %}
    Settings
    {% else %}
    New User Editor
    {% endif %}
{% endblock %}
{% block head %}
<script>

    //function to be used by the submit button. called by the template.
    function buildrequest() {
        var request = {};
        //for each item marked form-attribute, add its value to the request
        $('.form-attribute').each(function () {
            request[$(this).attr('id')] = $(this).val();
        });

        //establish an array under request to deal with a group of objects. This will:
        //1. cycle through every object with the class form-object-master and grab it's data-mapping value
        //2. cycle through this and every other object with that data-mapping and add its value to the object
        //3. push the resulting object to the request object
        request.objects = []
        //for each dropdown contiaining the instrument names
        $('.form-object-master').each(function () {
            if ($(this).val() != 'null' && $(this).val() != '' && $(this).val() != 'None') {
                //create a variable to dump this instrument's data into
                var ob = {};
                $('[data-mapping=' + $(this).data('mapping') + ']').each(function () {
                    ob[$(this).data('key')] = $(this).val();
                });
                //push its variable into the request.instruments array
                request.objects.push(ob);
            }
        });
        console.log('Sending request packet to server:')
        console.log(request)
        return request
    }

    $(document).ready(function () {

        //run when user changes the content of a isprimary dropdown to "yes". Sets all others to no.
        $(document).on("change", '[data-key=isprimary]', function (e) {
            //only run the code if it's the original event to prevent recursion (this function would go infinite otherwise)
            if (e.originalEvent && ($(this).val() == 1 || $(this).val() == '1')) {
                console.log('User selected an instrument to be their primary');
                $('[data-key=isprimary]').not(this).each(function () {
                    if ($(this).val() == 1 || $(this).val() == '1') {
                        $(this).val("0").change();
                    }
                });
            }
        });

        $(document).on("click", '#send_email', function (e) {
            $(this).prop('disabled', true).addClass('disabled');
            var request = {}
            request.users = []
            var user = {}
            user.userid = '{{ targetuser.userid }}'
            request.users.push(user);
            $.ajax({
                type: 'POST',
                url: '/user/{{thisuser.userid}}/email/',
                contentType: 'application/json;charset=UTF-8',
                data: JSON.stringify(request, null),
                success: function (data, textStatus) {
                    //upon success, the server will return a message and a URL. give the user the message and send them to the URL.
                    console.log(data);
                    if (data.message != 'none') {
                        alert(data.message);
                        isClicked = false;
                    }
                    if (data.url != 'none') {
                        window.location = data.url;
                    }
                    else {
                        isClicked = false;
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    alert('Submission failed with error: ' + errorThrown);
                    isClicked = false;
                },
            });
        });
    });
</script>
{% endblock %}
    {% block tools %}
        <h4><b>Tools</b></h4>
        <a href="#" class="w3-hover-black submit_button" data-method="POST">Submit</a>
    {% endblock %}
{% block content %}
{% if targetuser.userid is not none %}
    {% if thisuser.isadmin == 1 %}
    <h1>Editing User &#34;{{ targetuser.firstname }} {{ targetuser.lastname }}&#34;</h1>
    {% endif %}
{% else %}
    <h1>New User</h1>
{% endif %}
<h2>{% if thisuser.isadmin == 1 %}User{% else %}Your{% endif %} Settings</h2>
<p>Note: You will only be assigned a group if you are set to Active, and the group plays betwen your arrival and departure times.</p>
<table>
    <tbody>
        <tr>
            <td>First Name</td>
            <td>
                {% if targetuser.userid is not none and thisuser.isadmin == 1 %}
                <input type="text" id="firstname" class="form-attribute" value="{{ targetuser.firstname }}">
                {% elif thisuser.isadmin != 1 %}
                {{ targetuser.firstname }}
                {% else %}
                <input type="text" id="firstname" class="form-attribute" value="">
                {% endif %}
            </td>
        </tr>
        <tr>
            <td>Last Name</td>
            <td>
                {% if targetuser.userid is not none and thisuser.isadmin == 1 %}
                <input type="text" id="lastname" class="form-attribute" value="{{ targetuser.lastname }}">
                {% elif thisuser.isadmin != 1 %}
                {{ targetuser.lastname }}
                {% else %}
                <input type="text" id="lastname" class="form-attribute" value="">
                {% endif %}
            </td>
        </tr>
        {% if thisuser.isadmin == 1 %}
        <tr>
            <td>Email</td>
            <td>
                <input id="email" type="email" class="form-attribute" value="<HIDDEN>">
            </td>
        </tr>
        {% endif %}
        <tr>
            <td>Arrival</td>
            <td>
                <select id="arrival" class="form-attribute">
                    <option value="None"></option>
                    {% for p in periods %}
                    {% if p.starttime == targetuser.arrival %}
                    <option value="{{ p.starttime }}" selected="selected">{{ p.periodname }}, {{ p.starttime.strftime('%a, %d %b') }}</option>
                    {% else %}
                    <option value="{{ p.starttime }}">{{ p.periodname }}, {{ p.starttime.strftime('%a, %d %b') }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </td>
        </tr>
        <tr>
            <td>Departure</td>
            <td>
                <select id="departure" class="form-attribute">
                    <option value="None"></option>
                    {% for p in periods %}
                    {% if p.starttime == targetuser.departure %}
                    <option value="{{ p.starttime }}" selected="selected">{{ p.periodname }}, {{ p.starttime.strftime('%a, %d %b') }}</option>
                    {% else %}
                    <option value="{{ p.starttime }}">{{ p.periodname }}, {{ p.starttime.strftime('%a, %d %b') }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </td>
        </tr>
        <tr>
            <td>Active</td>
            <td>
                <select id="isactive" class="form-attribute">
                    {% if targetuser.isactive == 0 %}
                    <option value="0" selected="selected">Inactive</option>
                    <option value="1">Active</option>
                    {% else %}
                    <option value="0">Inactive</option>
                    <option value="1" selected="selected">Active</option>
                    {% endif %}
                </select>
            </td>
        </tr>
        {% if thisuser.isadmin == 1 %}
        <tr>
            <td>Announcer</td>
            <td>
                <select id="isannouncer" class="form-attribute">
                    {% if targetuser.isannouncer == 1 %}
                    <option value="0">No</option>
                    <option value="1" selected="selected">Yes</option>
                    {% else %}
                    <option value="0" selected="selected">No</option>
                    <option value="1">Yes</option>
                    {% endif %}
                </select>
            </td>
        </tr>
        <tr>
            <td>Conductor</td>
            <td>
                <select id="isconductor" class="form-attribute">
                    {% if targetuser.isconductor == 1 %}
                    <option value="0">No</option>
                    <option value="1" selected="selected">Yes</option>
                    {% else %}
                    <option value="0" selected="selected">No</option>
                    <option value="1">Yes</option>
                    {% endif %}
                </select>
            </td>
        </tr>
        <tr>
            <td>Admin</td>
            <td>
                <select id="isadmin" class="form-attribute">
                    {% if targetuser.isadmin == 1 %}
                    <option value="0">No</option>
                    <option value="1" selected="selected">Yes</option>
                    {% else %}
                    <option value="0" selected="selected">No</option>
                    <option value="1">Yes</option>
                    {% endif %}
                </select>
            </td>
        </tr>
        {% endif %}
    </tbody>
</table>
{% if thisuser.isadmin == 1 %}
<p>Send this user their dashboard link via email: <button type="button" id="send_email">Send Email</button></p>
{% endif %}
<h2>{% if thisuser.isadmin == 1 %}User{% else %}Your{% endif %} Instruments</h2>
<p>Note: You won't be assigned to play an instrument if it's set to inactive. The instrument you have set to primary will be allocated more than the others. If you wish to add any more instruments, contact camp administration.</p>
<table>
    <thead>
        <tr>
            <th>Instrument</th>
            {% if thisuser.isadmin == 1 %}
            <th>Grade</th>
            {% endif %}
            <th>Primary</th>
            <th>Active</th>
        </tr>
    <thead>
    <tbody>
        {% for t in targetuserinstruments %}
            <tr>
                <td>
                    <input type="hidden" data-key="instrumentid" data-mapping="{{t.instrumentid}}" value="{{t.instrumentid}}">
                    {% if thisuser.isadmin == 1 %}
                    <select class="form-object-master" data-key="instrumentname" data-mapping="{{t.instrumentid}}">
                        {% for i in instrumentlist %}
                        {% if t.instrumentname == i %}
                        <option value="{{i}}" selected="selected">{{i}}</option>
                        {% else %}
                        <option value="{{i}}">{{i}}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                    {% else %}
                    {{ t.instrumentname }}
                    {% endif %}
                </td>
                {% if thisuser.isadmin == 1 %}
                <td>
                    <select data-key="grade" data-mapping="{{t.instrumentid}}">
                        {% for n in range(maximumlevel + 1) %}
                        {% if n == t.grade %}
                        <option value="{{ n }}" selected="selected">{{ n }}</option>
                        {% else %}
                        <option value="{{ n }}">{{ n }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </td>
                {% endif %}
                <td>
                    <select data-key="isprimary" data-mapping="{{t.instrumentid}}">
                        {% if t.isprimary == 1 %}
                        <option value="0">No</option>
                        <option value="1" selected="selected">Yes</option>
                        {% else %}
                        <option value="0" selected="selected">No</option>
                        <option value="1">Yes</option>
                        {% endif %}
                    </select>
                </td>
                <td>
                    <select data-key="isactive" data-mapping="{{t.instrumentid}}">
                        {% if t.isactive == 1 %}
                        <option value="0">Inactive</option>
                        <option value="1" selected="selected">Active</option>
                        {% else %}
                        <option value="0" selected="selected">Inactive</option>
                        <option value="1">Active</option>
                        {% endif %}
                    </select>
                </td>
            </tr>
        {% endfor %}
        {% if thisuser.isadmin == 1 %}
        <tr>
            <td>
                <input type="hidden" data-key="instrumentid" data-mapping="new" value="new">
                <select class="form-object-master" data-key="instrumentname" data-mapping="new">
                    <option value=""></option>
                    {% for i in instrumentlist %}
                    <option value="{{i}}">{{i}}</option>
                    {% endfor %}
                </select>
            </td>
            <td>
                <select data-key="grade" data-mapping="new">
                    <option value=""></option>
                    {% for n in range(maximumlevel + 1) %}
                    <option value="{{ n }}">{{ n }}</option>
                    {% endfor %}
                </select>
            </td>
            <td>
                <select data-key="isprimary" data-mapping="new">
                    <option value=""></option>
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                </select>
            </td>
            <td>
                <select data-key="isactive" data-mapping="new">
                    <option value=""></option>
                    <option value="0">Inactive</option>
                    <option value="1">Active</option>
                </select>
            </td>
        </tr>
        {% endif %}
    </tbody>
</table>


{% endblock %}
{% block footer %}
<!-- Navbar -->
<div class="w3-bottom">
    <ul class="w3-navbar w3-theme w3-bottom w3-left-align w3-large">
        <li><a href="#" class="w3-hover-white submit_button" data-method="POST">Submit</a></li>
    </ul>
</div>
{% endblock %}
