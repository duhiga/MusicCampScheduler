{% extends "layout.html" %}
{% block title %}{{ campname }} Group Editor{% endblock %}
{% block pagename %}&#34;{{ thisgroup.groupname }}&#34; Editor{% endblock %}
{% block head %}
    <script>
        $(document).ready(function () {

            var isClicked = false;

            //turn the dump of all players available in this period to a JS object
            {% if playersdump_serialized == [] %}
            var playersdump = null;
            {% else %}
            var playersdump = {{ playersdump_serialized|tojson }};
            {% endif %}
            console.log("Available Players:");
            console.log(playersdump);
            
            //turn the dump of all players already playing in this group to a JS object
            {% if thisgroupplayers_serialized == [] %}
            var thisgroupplayers = null;
            {% else %}
            var thisgroupplayers = {{ thisgroupplayers_serialized|tojson }};
            {% endif %}
            console.log("Players already playing in this group:");
            console.log(thisgroupplayers);

            {% if grouptemplates_serialized == [] %}
            var grouptemplates = null;
            {% else %}
            var grouptemplates = {{ grouptemplates_serialized|tojson }};
            {% endif %}
            console.log("Group Templates:");
            console.log(grouptemplates);

            //changes all player dropdowns to match the players already playing in the group. 
            //Sets the players to bold in their respective dropdowns.
            instrumentcounter = {}
            if (thisgroupplayers != null) {
                for (var i = 0; i < thisgroupplayers.length; i++) {
                    if (instrumentcounter[thisgroupplayers[i].instrumentname] == null) {
                        instrumentcounter[thisgroupplayers[i].instrumentname] = 0;
                    }
                    $("#" + thisgroupplayers[i].instrumentname + "_" + instrumentcounter[thisgroupplayers[i].instrumentname]).val(thisgroupplayers[i].userid).change();
                    $("#" + thisgroupplayers[i].instrumentname + "_" + instrumentcounter[thisgroupplayers[i].instrumentname] + " option:selected").css("font-weight","Bold");
                    instrumentcounter[thisgroupplayers[i].instrumentname]++;

                };
            }

            //this function updates the table slot containing the total number of players in the group.
            function updatetotal() {
                var sum = 0;
                $('.instrumentnumber_dropdown').each(function() {
                    sum += Number($(this).val());
                });
                $("#total_players").html(sum).change();
            }
            
            //when the page loads for the first time, update the total
            updatetotal();
            
            //adds a player dropdown to a given cell
            function addPlayer(cell) {
                instrument = cell.attr('data-instrument')
                var sel = ($('<select class="player_dropdown" data-instrument="' + instrument + '">')).appendTo(cell);
                sel.append($("<option>").attr('value',""));
                for (var i = 0; i < playersdump.length; i++) {
                    if (playersdump[i].instrumentname == instrument) {
                        sel.append($("<option>").attr('value',playersdump[i].userid).text(playersdump[i].grade + ' - ' + playersdump[i].firstname + ' ' + playersdump[i].lastname));
                    }
                }
            }

            //removes the last player dropdown in a cell
            function removePlayer(cell) {
                dropdowns = jQuery(cell).find('.player_dropdown')
                dropdowns[dropdowns.length - 1].remove()
            }

            //run when a user changes the select template dropdown
            $(document).on("change", '#group_template_dropdown', function () {
                //get the user selected template and format it so we can iterate over it later
                var grep_template = $.grep(grouptemplates, function (elt) {
                    return elt.grouptemplatename === $(group_template_dropdown).val();
                });
                selectedTemplate = grep_template[0];
                console.log('Selected template is:');
                console.log(selectedTemplate);
                $('#groupname').val(selectedTemplate.grouptemplatename).change();
                //for each instrument type in the group template
                $.each(selectedTemplate, function(key,value) {
                    //make sure it's an instrument type and not other associated metadata
                    if (key != 'grouptemplateid' && key != 'grouptemplatename' && key != 'size' && key != 'minimumlevel' && key != 'maximumlevel' && key != 'defaultlocationid') {
                        console.log(key + ": "+String(value));
                        if (value == '' || value == null) {
                            value = 0;
                        }
                        $('#number_' + key).val(value).change();
                        console.log('attempted to change instrument textbox ' + key + ' to ' + value);
                    }
                });
            });

            //when user changes any instrument number drop down boxes
            $(document).on("change", '.instrumentnumber_dropdown', function () {
                updatetotal();
                thisinstrument = $(this).attr('data-instrument');
                playerscell = $('.players_cell[data-instrument="' + thisinstrument + '"]');
                difference = $(this).val() - $('.player_dropdown[data-instrument="' + thisinstrument + '"]').length;
                console.log('Need to add ' + difference + ' dropdowns');
                if (difference > 0) {
                    for (i=0; i < difference; i++) {
                        addPlayer(playerscell);
                    }
                }
                if (difference < 0) {
                    for (i=0; i > difference; i--) {
                        removePlayer(playerscell);
                    }
                } 
            });

            //when user changes the period dropdown box, reload the page with data from the new period
            $(document).on("change", '#periodid', function () {
                console.log('User selected period ' + $(this).val() + ', reloading page for that period');
                groupid = '{{ thisgroup.groupid }}'
                if (groupid == 'None') {
                    groupid = 'new';
                }
                window.location = '/user/{{ thisuser.userid }}/group/' + groupid + '/period/' + $(this).val() + '/edit/';
            });

            //run when user changes the content of a player dropdown
            $(document).on("change", '.player_dropdown', function (e) {
                //grab value that was selected on the dropdown
                var selectedplayer = $(this).val();
                //only run the code if it's the original event to prevent recursion (this function would go infinite otherwise)
                if (e.originalEvent) {
                    //for each other drop down box
                    $('.player_dropdown').not(this).each(function() {
                        //set any other boxes with the same player name to blank
                        if ($(this).val() == selectedplayer) {
                            $(this).val("").change();
                        }
                    });
                }
            });

            //when user presses any submit button (submit, save or autofill)
            $(".submit_button").click(function () {
                if (!isClicked) {
                    isClicked = true;
                    console.log('Submit button pressed');
                    var id = $(this).attr('id')
                    //establish the object we'll send to the server
                    var request = {}

                    //check if this was the autofill button or not, and add this information to the object
                    request.submittype = id

                    //for each group_attribute dropdown on the page, add the value to the object
                    $('.group_attribute').each(function() {
                        request[$(this).attr('id')] = $(this).val();
                    });

                    $('.instrumentnumber_dropdown').each(function() {
                        request[$(this).data('instrument')] = $(this).val();
                    });

                    //establish an array to fill with player and instruments
                    request.players = []
                    $('.player_dropdown').each(function() {
                        //create a new object
                        var iplayer = {};
                        //add the contents of the instrument dropdown to the object
                        iplayer.instrumentname = $(this).data('instrument');
                        iplayer.userid = $(this).val();
                        //push the player object to the players array in the request object
                        request.players.push(iplayer);
                    });

                    console.log('Sending the following to the server:');
                    console.log(request);
                    $.ajax({
                        //make a POST AJAX query to the same web page as the user is currently visiting
                        url: (window.location),
                        type: 'POST',
                        contentType: 'application/json;charset=UTF-8',
                        data: JSON.stringify(request, null),
                        success: function(data) {
                            //upon success, the server will return a message and a URL. give the user the message and send them to the URL.
                            console.log(data);
                            if (data.message != 'none') {
                                alert(data.message);
                                isClicked = false;
                            }
                            if (data.url != 'none') {
                                window.location = data.url;
                            }
                            else {
                                isClicked = false;
                            }
                        }
                    });
                }
            });

            //when user presses the delete group button
            $("#clear_players").click(function () {
                console.log('Clear players button pressed');
                $('.player_dropdown').each(function() {
                    $(this).val('').change();
                });
                w3_close();
            });

            //when user presses the delete group button
            $("#delete").click(function () {
                if (!isClicked) {
                    console.log('Delete button pressed');
                    var r = confirm('Are you sure you want to delete this group?');
                    if (r == true) {
                        $.ajax({
                            //make a POST AJAX query to the same web page as the user is currently visiting
                            url: (window.location.href),
                            type: 'DELETE',
                            success: function(data) {
                                //upon success, the server will return a message and a URL. give the user the message and send them to the URL.
                                console.log(data);
                                if (data.message != 'none') {
                                    alert(data.message);
                                    isClicked = false;
                                }
                                if (data.url != 'none') {
                                    window.location = data.url;
                                }
                                else {
                                    isClicked = false;
                                }
                            }
                        });
                    }
                }
            });
        });
    </script>
{% endblock %}
{% block tools %}
    <h4><b>Edit</b></h4>
    <a href="#" class="w3-hover-black" id="clear_players">Clear Players</a>
    <a href="#" class="w3-hover-black submit_button" id="autofill">Autofill Missing Players</a>
    <a href="#" class="w3-hover-black submit_button" id="save">Save Changes</a>
    <a href="#" class="w3-hover-black" id="delete">Delete Group</a>
{% endblock %}
{% block content %}
                <h2>Group Configuration</h2>
                <table style="width:100%">
                    <tr>
                        <th>Attribute</th>
                        <th class="unimportant-column">Current</th>
                        <th>Change</th>
                    </tr>
                    <tr>
                        <th>Name</th>
                        <td class="unimportant-column">{{ thisgroup.groupname }}</td>
                        <td><input type="text" id="groupname" class="group_attribute" value="{% if thisgroup.groupname != None %}{{ thisgroup.groupname }}{% endif %}"></td>
                    </tr>
                    <tr>
                        <th>Status</th>
                        <td class="unimportant-column">{{ thisgroup.status }}</td>
                        <td>
                            <select id="status" class="group_attribute">
                                {% if thisgroup.status == "Confirmed" %}
                                <option value="Queued">Queued</option>
                                <option value="Confirmed" selected="selected">Confirmed</option>
                                {% else %}
                                <option value="Queued" selected="selected">Queued</option>
                                <option value="Confirmed">Confirmed</option>
                                {% endif %}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th>Music</th>
                        <td class="unimportant-column">{{ thisgroup.music }}</td>
                        <td><input type="text" id="music" class="group_attribute" value="{{ thisgroup.music }}"></td>
                    </tr>
                    <tr>
                        <th>Period</th>
                        <td class="unimportant-column">
                            {% if currentperiod != None %}
                            {{ currentperiod.periodname }}, {{ currentperiod.starttime.strftime('%a, %d %b') }}, {{ currentperiod.starttime.strftime('%H:%M') }}-{{ currentperiod.endtime.strftime('%H:%M') }}
                        </td>
                        {% endif %}
                        <td>
                            <select id="periodid" class="group_attribute">
                                <option value="None"></option>
                                {% for p in periods %}
                                {% if p.periodid == selectedperiod.periodid %}
                                <option value="{{ p.periodid }}" selected="selected">{{ p.periodname }}, {{ p.starttime.strftime('%a, %d %b') }}, {{ p.starttime.strftime('%H:%M') }}</option>
                                {% else %}
                                <option value="{{ p.periodid }}">{{ p.periodname }}, {{ p.starttime.strftime('%a, %d %b') }}, {{ p.starttime.strftime('%H:%M') }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th>Location</th>
                        <td class="unimportant-column">{{ thislocation.locationname }}</td>
                        <td>
                            <select id="locationid" class="group_attribute">
                                {% for l in locations %}
                                {% if l.locationid == thislocation.locationid %}
                                <option value="{{ l.locationid }}" selected="selected">{{ l.locationname }} - Max Capacity: {{ l.capacity }}</option>
                                {% else %}
                                <option value="{{ l.locationid }}">{{ l.locationname}} - Max Capacity: {{ l.capacity }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th>Minimum Level</th>
                        <td class="unimportant-column">{{ thisgroup.minimumlevel }}</td>
                        <td>
                            <select id="minimumlevel" class="group_attribute">
                                {% for n in range(maximumlevel + 1) %}
                                {% if n == thisgroup.minimumlevel and n == 0 %}
                                <option value="{{ n }}" selected="selected">Auto</option>
                                {% elif n == thisgroup.minimumlevel %}
                                <option value="{{ n }}" selected="selected">{{ n }}</option>
                                {% elif n == 0 %}
                                <option value="{{ n }}">Auto</option>
                                {% else %}
                                <option value="{{ n }}">{{ n }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th>Maximum Level</th>
                        <td class="unimportant-column">{{ thisgroup.maximumlevel }}</td>
                        <td>
                            <select id="maximumlevel" class="group_attribute">
                                {% for n in range(maximumlevel + 1) %}
                                {% if n == thisgroup.maximumlevel and n == 0 %}
                                <option value="{{ n }}" selected="selected">Auto</option>
                                {% elif n == thisgroup.maximumlevel %}
                                <option value="{{ n }}" selected="selected">{{ n }}</option>
                                {% elif n == 0 %}
                                <option value="{{ n }}">Auto</option>
                                {% else %}
                                <option value="{{ n }}">{{ n }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th>Counted towards play totals</th>
                        <td class="unimportant-column">
                            {% if thisgroup.ismusical == 0 %}No
                            {% else %}Yes
                            {% endif %}
                        </td>
                        <td>
                            <select id="ismusical" class="group_attribute">
                                {% if thisgroup.ismusical == 0 %}
                                <option value="1">Yes</option>
                                <option value="0" selected="selected">No</option>
                                {% else %}
                                <option value="1" selected="selected">Yes</option>
                                <option value="0">No</option>
                                {% endif %}
                            </select>
                        </td>
                    </tr>
                    <tr class="unimportant-column">
                        <th>Requested User</th>
                        <td colspan="2" class="unimportant-column">{{ thisgroup.requesteduserid }}</td>
                    </tr>
                    <tr class="unimportant-column">
                        <th>Request Time</th>
                        <td colspan="2" class="unimportant-column">
                            {% if thisgroup.requesttime != None %}
                            {{ thisgroup.requesttime.strftime('%A, %Y-%m-%d') }}, {{ thisgroup.requesttime.strftime('%H:%M') }}
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Total Players:</th>
                        <td id="total_players"></td>
                    </tr>
                </table>
                <h2>Players</h2>
                <p>Players bolded in the below table are the current players in that group. Player are shown with their grades on the respective instruments before their names.</p>
                <p>
                    Optional: Select a group template to autofill the page. Note - this wipes the current configuration.
                    <select id="group_template_dropdown">
                        <option value=""></option>
                        {% for g in grouptemplates %}
                        <option value="{{ g.grouptemplatename }}">{{ g.grouptemplatename }}</option>
                        {% endfor %}
                    </select>
                </p>
                <table class="sortable" id="table_players">
                    <tr>
                        <th>Instrument</th>
                        <th>Number</th>
                        <th>Current Players</th>
                        <!--<th>Available Players</th>-->
                    </tr>
                    {% set count = 0 -%}
                    {% for i in instrumentlist %}
                    <tr id="row_{{ i }}">
                        <td>{{ i }}</td>
                        <td>
                            <select class="instrumentnumber_dropdown" id="number_{{ i }}" data-instrument="{{i}}">
                                {% set n = 21 %}
                                {% for n in range(n) %}
                                {% if n == thisgroup[i] %}
                                <option value="{{ n }}" selected="selected">{{ n }}</option>
                                {% else %}
                                <option value="{{ n }}">{{ n }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </td>
                        <td class="players_cell" data-instrument="{{i}}">
                            {% if thisgroup[i] %}
                            {% for p in range(thisgroup[i]) %}
                            <select class="player_dropdown" id="{{i}}_{{p}}" data-instrument="{{i}}">
                                <option value=""></option>
                                {% for d in playersdump %}
                                {% if d.instrumentname == 'Conductor' and d.userid == thisgroup.requesteduserid %}
                                <option value="{{ d.userid }}" selected="selected">{{ d.grade }} - {{ d.firstname }} {{ d.lastname }}</option>
                                {% elif d.instrumentname == i %}
                                <option value="{{ d.userid }}">{{ d.grade }} - {{ d.firstname }} {{ d.lastname }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                            {% endfor %}
                            {% endif %}
                        </td>
                        <!-- <td class="available_players" data-instrument="{{i}}"></td> -->
                    </tr>
                    {% endfor %}
                </table>
{% endblock %}
{% block footer %}
<!-- Navbar -->
<div class="w3-bottom">
    <ul class="w3-navbar w3-theme w3-bottom w3-left-align w3-large">
        <li><a href="#" class="w3-hover-white submit_button" id="submit">Submit</a></li>
    </ul>
</div>
{% endblock %}