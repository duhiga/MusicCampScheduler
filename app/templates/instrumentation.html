{% extends "layout.html" %}
{% block title %}{{ campname }} Instrumentation{% endblock %}
{% block pagename %}Large Group Instrumentation{% endblock %}
{% block head %}
    <script>

        /* this script handles all user interaction in the group request page. Upon page load, it downloads all players
        in the camp including the instruments they play, all templates as stated by the config.xml, and the instruments
        this user plays. it uses all of this data to populate drop-down boxes, depending on what the user selects. */
        
        $(document).ready(function () {

            var grouptemplates = {{ grouptemplates_serialized|tojson }};
            console.log("Grouptemplates:");
            console.log(grouptemplates);

            var isClicked = false;

            //run when a user changes the select template dropdown
            $(document).on("change", '#group_template_dropdown', function () {
                //get the user selected template and format it so we can iterate over it later
                var grep_template = $.grep(grouptemplates, function (elt) {
                    return elt.grouptemplatename === $(group_template_dropdown).val();
                });
                selectedTemplate = grep_template[0];
                console.log('Selected template is:');
                console.log(selectedTemplate);
                $("#textbox_groupname").val(selectedTemplate.grouptemplatename)
                console.log('This group template minimum level is ' + selectedTemplate.minimumlevel)
                $("#minimumlevel_dropdown").val(selectedTemplate.minimumlevel).change()
                $("#maximumlevel_dropdown").val(selectedTemplate.maximumlevel).change()
                $("#location_dropdown").val(selectedTemplate.defaultlocationid).change()
                //for each instrument type in the group template
                $.each(selectedTemplate, function(key,value){
                    //make sure it's an instrument type and not other associated metadata
                    if (key != 'grouptemplateid' && key != 'grouptemplatename' && key != 'size') {
                        console.log(key + ": "+String(value));
                        //if the current instrument we're looking at is the same as the one that we selected for the user, decrement it because we already have one player
                        $('#' + key).val('').change();
                        if (value > 0) {
                            $('#' + key).val(value).change();
                            console.log('attempted to change instrument textbox ' + key + ' to ' + value);
                        }
                    }
                });
            });

            //run when user clicks the submit button
            $(".submit_button").click(function () {
                console.log('Submit button pressed');
                if (!isClicked) {
                    isClicked = true;
                    //set up a variable to track invalid configuration and the JSON to send through to the server
                    var invalidConfig = false;
                    //request will be our parent object, and will be pushed to the server through AJAX later
                    var request = {};
                    //add the music name and minimum level to the JSON. Establish an array to contain the player names
                    request.music = $('#textbox_music').val();
                    //if this is the conductorpage, we also need to send the selected location - it cannot be blank.
                    if ($('#location_dropdown').val() == "" || $('#textbox_groupname').val() == "" || $('#textbox_music').val() == "") {
                        alert("Sumbission failed. You have not filled in required fields. You must fill in the location, music and name of the group.");
                        isClicked = false;
                        return false;
                    }
                    else {
                        request.locationid = $('#location_dropdown').val();
                        request.groupname = $('#textbox_groupname').val();
                        request.music = $('#textbox_music').val();
                        request.minimumlevel = $('#minimumlevel_dropdown').val();
                        request.maximumlevel = $('#maximumlevel_dropdown').val();
                        request.conductoruserid = $('#conductorid').val();
                        //establish an array to fill with instruments and numbers
                        request.instruments = []
                        //for each instrument
                        $('.instrumentnumber_dropdown').each(function() {
                            //if we find a blank instrument box
                            if ($(this).val() == "") {
                                console.log("Selected " + $(this).attr('id') + " as None");
                            }
                            else {
                                request[$(this).attr('id')] = $(this).val();
                                console.log("Selected " + $(this).attr('id') + ' as ' + $(this).val());
                            }
                        });
                        console.log('Pushing the following object to the server for processing:');
                        console.log(JSON.stringify(request));
                    
                        if (invalidConfig == false) {
                            $.ajax({
                                //make a POST AJAX query to the same web page as the user is currently visiting
                                url: (window.location.href),
                                type: 'POST',
                                contentType: 'application/json;charset=UTF-8',
                                data: JSON.stringify(request, null),
                                success: function(data) {
                                    //upon success, the server will return a message and a URL. give the user the message and send them to the URL.
                                    console.log(data);
                                    if (data.message != 'none') {
                                        alert(data.message);
                                        isClicked = false;
                                    }
                                    if (data.url != 'none') {
                                        window.location = data.url;
                                    }
                                    else {
                                        isClicked = false;
                                    }
                                }
                            });
                        
                        }
                    }
                }
            });
        });
    </script>
{% endblock %}
{% block tools %}
    <h4><b>Tools</b></h4>
    <a href="#" class="w3-hover-black submit_button">Submit</a>
{% endblock %}
{% block content %}
            <p>
                Optional: Select a group template to autofill the page
                <select id="group_template_dropdown">
                    <option value=""></option>
                    {% for g in grouptemplates %}
                    <option value="{{ g.grouptemplatename }}">{{ g.grouptemplatename }}</option>
                    {% endfor %}
                </select>
            </p>
            <h2>Group Configuration</h2>
            <table id="configTable">
                <tr>
                    <th>Period Name</th>
                    <td>{{ thisperiod.periodname }}</td>
                </tr>
                <tr>
                    <th>Date</th>
                    <td>{{ thisperiod.starttime.strftime('%A, %Y-%m-%d') }}</td>
                </tr>
                <tr>
                    <th>Group Name</th>
                    <td><input type="text" id="textbox_groupname"></td>
                </tr>
                <tr>
                    <th>Music</th>
                    <td><input type="text" id="textbox_music"></td>
                </tr>
                <tr>
                    <th>Location</th>
                    <td>
                        <select id="location_dropdown">
                            {% for l in locations %}
                            <option value="{{ l.locationid }}">{{ l.locationname }}</option>
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Minimum Level</th>
                    <td>
                        <select id="minimumlevel_dropdown">
                            {% for n in range(maximumlevel + 1) %}
                            {% if n  == 0 %}
                            <option value="{{ n }}">Auto</option>
                            {%else%}
                            <option value="{{ n }}">{{ n }}</option>
                            {%endif%}
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Maximum Level</th>
                    <td>
                        <select id="maximumlevel_dropdown">
                            {% for n in range(maximumlevel + 1) %}
                            {% if n  == 0 %}
                            <option value="{{ n }}">Auto</option>
                            {%else%}
                            <option value="{{ n }}">{{ n }}</option>
                            {%endif%}
                            {% endfor %}
                        </select>
                    </td>
                </tr>
            </table>
            <p>
                Conductor Name:
                <select id="conductorid">
                    <option value=""></option>
                    {% for c in conductors %}
                        {% if c.userid == thisuser.userid %}
                            <option value="{{ c.userid }}" selected="selected">{{ c.firstname }} {{ c.lastname }}</option>
                        {% else %}
                            <option value="{{ c.userid }}">{{ c.firstname }} {{ c.lastname }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </p>
            <h2>Group Instrumentation</h2>
            <table id="playersTable">
                <!--Table Headers-->
                <tr>
                    <th>Instrument</th>
                    <th>Number</th>
                </tr>
                {% for i in instrumentlist %}
                <tr>
                    <td>{{ i }}</td>
                    <td>
                        <select class="instrumentnumber_dropdown" id="{{ i }}">
                            {% set n = 21 %}
                            {% for n in range(n) %}
                                <option value="{{ n }}">{{ n }}</option>
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                {% endfor %}
            </table>
{% endblock %}
{% block footer %}
<!-- Navbar -->
    <div class="w3-bottom">
        <ul class="w3-navbar w3-theme w3-bottom w3-left-align w3-large">
            <li><a href="#" class="w3-hover-white submit_button">Submit</a></li>
        </ul>
    </div>
{% endblock %}