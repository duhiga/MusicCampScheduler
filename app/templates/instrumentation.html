{% extends "layout.html" %}
{% block title %}{{ campname }} Instrumentation{% endblock %}
{% block pagename %}Large Group Instrumentation{% endblock %}
{% block head %}
    <script>

        //function to be used by the submit button. called by the template.
        function buildrequest() {
            var request = {};
            request.locationid = $('#location_dropdown').val();
            request.groupname = $('#textbox_groupname').val();
            request.music = $('#textbox_music').val();
            request.minimumlevel = $('#minimumlevel_dropdown').val();
            request.maximumlevel = $('#maximumlevel_dropdown').val();
            request.conductoruserid = $('#conductorid').val();
            //establish an array to fill with instruments and numbers
            request.instruments = []
            //for each instrument
            $('.instrumentnumber_dropdown').each(function() {
                //if we find a blank instrument box
                if ($(this).val() == "") {
                    console.log("Selected " + $(this).attr('id') + " as None");
                }
                else {
                    request[$(this).attr('id')] = $(this).val();
                    console.log("Selected " + $(this).attr('id') + ' as ' + $(this).val());
                }
            });
            return request
        }

        /* this script handles all user interaction in the group request page. Upon page load, it downloads all players
        in the camp including the instruments they play, all templates as stated by the config.xml, and the instruments
        this user plays. it uses all of this data to populate drop-down boxes, depending on what the user selects. */
        
        $(document).ready(function () {

            var grouptemplates = {{ grouptemplates_serialized|tojson }};
            console.log("Grouptemplates:");
            console.log(grouptemplates);

            //run when a user changes the select template dropdown
            $(document).on("change", '#group_template_dropdown', function () {
                //get the user selected template and format it so we can iterate over it later
                var grep_template = $.grep(grouptemplates, function (elt) {
                    return elt.grouptemplatename === $(group_template_dropdown).val();
                });
                selectedTemplate = grep_template[0];
                console.log('Selected template is:');
                console.log(selectedTemplate);
                $("#textbox_groupname").val(selectedTemplate.grouptemplatename)
                console.log('This group template minimum level is ' + selectedTemplate.minimumlevel)
                $("#minimumlevel_dropdown").val(selectedTemplate.minimumlevel).change()
                $("#maximumlevel_dropdown").val(selectedTemplate.maximumlevel).change()
                $("#location_dropdown").val(selectedTemplate.defaultlocationid).change()
                //for each instrument type in the group template
                $.each(selectedTemplate, function(key,value){
                    //make sure it's an instrument type and not other associated metadata
                    if (key != 'grouptemplateid' && key != 'grouptemplatename' && key != 'size') {
                        console.log(key + ": "+String(value));
                        //if the current instrument we're looking at is the same as the one that we selected for the user, decrement it because we already have one player
                        $('#' + key).val('').change();
                        if (value > 0) {
                            $('#' + key).val(value).change();
                            console.log('attempted to change instrument textbox ' + key + ' to ' + value);
                        }
                    }
                });
            });
        });
    </script>
{% endblock %}
{% block tools %}
    <h4><b>Tools</b></h4>
    <a href="#" class="w3-hover-black submit_button" data-method="POST">Submit</a>
{% endblock %}
{% block content %}
            <p>
                Optional: Select a group template to autofill the page
                <select id="group_template_dropdown">
                    <option value=""></option>
                    {% for g in grouptemplates %}
                    <option value="{{ g.grouptemplatename }}">{{ g.grouptemplatename }}</option>
                    {% endfor %}
                </select>
            </p>
            <h2>Group Configuration</h2>
            <table id="configTable">
                <tr>
                    <th>Period Name</th>
                    <td>{{ thisperiod.periodname }}</td>
                </tr>
                <tr>
                    <th>Date</th>
                    <td>{{ thisperiod.starttime.strftime('%A, %Y-%m-%d') }}</td>
                </tr>
                <tr>
                    <th>Group Name</th>
                    <td><input type="text" id="textbox_groupname"></td>
                </tr>
                <tr>
                    <th>Music</th>
                    <td><input type="text" id="textbox_music"></td>
                </tr>
                <tr>
                    <th>Location</th>
                    <td>
                        <select id="location_dropdown">
                            {% for l in locations %}
                            <option value="{{ l.locationid }}">{{ l.locationname }}</option>
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Minimum Level</th>
                    <td>
                        <select id="minimumlevel_dropdown">
                            {% for n in range(maximumlevel + 1) %}
                            {% if n  == 0 %}
                            <option value="{{ n }}">Auto</option>
                            {%else%}
                            <option value="{{ n }}">{{ n }}</option>
                            {%endif%}
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Maximum Level</th>
                    <td>
                        <select id="maximumlevel_dropdown">
                            {% for n in range(maximumlevel + 1) %}
                            {% if n  == 0 %}
                            <option value="{{ n }}">Auto</option>
                            {%else%}
                            <option value="{{ n }}">{{ n }}</option>
                            {%endif%}
                            {% endfor %}
                        </select>
                    </td>
                </tr>
            </table>
            <p>
                Conductor Name:
                <select id="conductorid">
                    <option value=""></option>
                    {% for c in conductors %}
                        {% if c.userid == thisuser.userid %}
                            <option value="{{ c.userid }}" selected="selected">{{ c.firstname }} {{ c.lastname }}</option>
                        {% else %}
                            <option value="{{ c.userid }}">{{ c.firstname }} {{ c.lastname }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </p>
            <h2>Group Instrumentation</h2>
            <table id="playersTable">
                <!--Table Headers-->
                <tr>
                    <th>Instrument</th>
                    <th>Number</th>
                </tr>
                {% for i in instrumentlist %}
                <tr>
                    <td>{{ i }}</td>
                    <td>
                        <select class="instrumentnumber_dropdown" id="{{ i }}">
                            {% set n = 21 %}
                            {% for n in range(n) %}
                                <option value="{{ n }}">{{ n }}</option>
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                {% endfor %}
            </table>
{% endblock %}
{% block footer %}
<!-- Navbar -->
    <div class="w3-bottom">
        <ul class="w3-navbar w3-theme w3-bottom w3-left-align w3-large">
            <li><a href="#" class="w3-hover-white submit_button" data-method="POST">Submit</a></li>
        </ul>
    </div>
{% endblock %}